//
// Created by Fir on 2024/3/7 007.
//

#include <vector>
#include "astra_logo.h"
#include "astra_rocket.h"




std::vector<uint8_t> Compass = {
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x07, 0xf8, 0xff, 0xff, 0x01, 0xe0, 0xff,
    0x7f, 0xf0, 0x83, 0xff, 0x3f, 0xfc, 0x0f, 0xff, 0x1f, 0xff, 0x3f, 0xfe, 0x8f, 0xff, 0x7f, 0xfc,
    0xcf, 0xff, 0xff, 0xfc, 0xc7, 0xff, 0xe7, 0xf8, 0xe7, 0xff, 0xe0, 0xf9, 0xe3, 0x3f, 0xf0, 0xf1,
    0xf3, 0x0f, 0xf0, 0xf3, 0xf3, 0x07, 0xf0, 0xf3, 0xf3, 0xc7, 0xf8, 0xf3, 0xf3, 0xc7, 0xf8, 0xf3,
    0xf3, 0x03, 0xfc, 0xf3, 0xf3, 0x03, 0xfc, 0xf3, 0xe3, 0x03, 0xff, 0xf1, 0xe7, 0xc1, 0xff, 0xf9,
    0xc7, 0xf9, 0xff, 0xf8, 0xcf, 0xff, 0xff, 0xfc, 0x8f, 0xff, 0x7f, 0xfc, 0x1f, 0xff, 0x3f, 0xfe,
    0x3f, 0xfc, 0x0f, 0xff, 0x7f, 0xf0, 0x83, 0xff, 0xff, 0x01, 0xe0, 0xff, 0xff, 0x07, 0xf8, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x3f
};
std::vector<uint8_t> Timer = {
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x0f, 0xf8, 0xff, 0xff, 0x01, 0xe0, 0xff,
    0x7f, 0x00, 0x80, 0xff, 0x3f, 0xf8, 0x07, 0xff, 0x1f, 0xfe, 0x1f, 0xfe, 0x0f, 0xbf, 0x3f, 0xfc,
    0x87, 0x1f, 0x7f, 0xf8, 0xc7, 0x1f, 0xff, 0xf8, 0xe3, 0x1f, 0xff, 0xf1, 0xe3, 0x1f, 0xff, 0xf1,
    0xf3, 0x1f, 0xff, 0x73, 0xf1, 0x1f, 0xff, 0x63, 0xf1, 0x1f, 0xff, 0x63, 0xf1, 0x1f, 0xc0, 0x63,
    0xf1, 0x1f, 0xc0, 0x63, 0xf1, 0x3f, 0xe0, 0xe3, 0xf3, 0xff, 0xff, 0xe3, 0xe3, 0xff, 0xff, 0xf1,
    0xe3, 0xff, 0xff, 0xf1, 0xc7, 0xff, 0xff, 0xf8, 0xc7, 0xff, 0xff, 0xf8, 0x8f, 0xff, 0x7f, 0xfc,
    0x0f, 0xff, 0x3f, 0xfc, 0x1f, 0xfc, 0x0f, 0xfe, 0x3f, 0xe0, 0x01, 0xff, 0xff, 0x00, 0xc0, 0xff,
    0xff, 0x03, 0xf0, 0xff, 0xff, 0xff, 0xff, 0x3f

};

std::vector<uint8_t> Weather = {
    0xff, 0x07, 0xfe, 0xff, 0xff, 0x01, 0xf8, 0xff, 0xff, 0xf8, 0xf1, 0xff, 0x7f, 0xfc, 0xe3, 0xff,
    0x7f, 0xfe, 0xc7, 0xff, 0x3f, 0xff, 0x0f, 0xfe, 0x3f, 0xff, 0x0f, 0xf8, 0x3f, 0xff, 0xff, 0xf1,
    0x0f, 0xff, 0xff, 0xe3, 0x03, 0xff, 0xff, 0x67, 0xf1, 0xff, 0xff, 0x67, 0xf9, 0xff, 0xff, 0x6f,
    0xf9, 0xff, 0xff, 0x6f, 0xfd, 0xff, 0xff, 0x6f, 0xfd, 0xff, 0xff, 0x67, 0xf9, 0xff, 0xff, 0x67,
    0xf9, 0xff, 0xff, 0x73, 0xe1, 0xff, 0xff, 0xf0, 0x03, 0x00, 0x00, 0xfc, 0x0f, 0x00, 0x00, 0xff,
    0xff, 0xff, 0xff, 0xff, 0x3f, 0xcf, 0xf3, 0xfc, 0x1f, 0xc7, 0x71, 0xfc, 0x8f, 0xe3, 0x38, 0xfe,
    0xc7, 0x71, 0x1c, 0xff, 0x6f, 0xdb, 0xb6, 0xff, 0x3f, 0xce, 0xf3, 0xff, 0x1f, 0xc7, 0xf1, 0xff,
    0x8f, 0xe3, 0xf8, 0xff, 0xcf, 0xf3, 0xfc, 0x3f

    };

std::vector<uint8_t> Photo = {
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x7f, 0x00, 0x00, 0xf0,
    0x3f, 0xff, 0xff, 0xe3, 0x9f, 0xff, 0xff, 0xe7, 0x9f, 0xff, 0xff, 0xef, 0x07, 0x00, 0xc0, 0xef,
    0x03, 0x00, 0x00, 0x6f, 0xf9, 0xff, 0x3f, 0x6f, 0xfd, 0xff, 0x7f, 0x6e, 0x1d, 0xff, 0x7f, 0x6e,
    0x4d, 0xfe, 0x7f, 0x6e, 0xcd, 0xfe, 0x7f, 0x6e, 0x0d, 0x7e, 0x7c, 0x6e, 0x3d, 0x3f, 0x79, 0x6e,
    0xfd, 0x9f, 0x73, 0x6e, 0xfd, 0xcf, 0x67, 0x6e, 0x1d, 0xe6, 0x6f, 0x6e, 0xcd, 0xf2, 0x4f, 0x6e,
    0xe5, 0xf8, 0x1f, 0x66, 0xf1, 0xfd, 0x3f, 0x70, 0xf9, 0xff, 0x7f, 0x78, 0xf9, 0xff, 0x7f, 0x7e,
    0xf9, 0xff, 0x7f, 0x7e, 0xf1, 0xff, 0x3f, 0xff, 0x03, 0x00, 0x80, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x3f

};

std::vector<uint8_t> Setting = {
    0xFF, 0xFF, 0xFF, 0x3F, 0xFF, 0xFF, 0xFF, 0x3F, 0xFF, 0xFF, 0xFF, 0x3F, 0xFF, 0xFF, 0xFF, 0x3F,
    0xFF, 0x1F, 0xFE, 0x3F, 0xFF, 0x1F, 0xFE, 0x3F, 0xFF, 0x0C, 0xCC, 0x3F, 0x7F, 0x00, 0x80, 0x3F,
    0x3F, 0x00, 0x00, 0x3F, 0x3F, 0xE0, 0x01, 0x3F, 0x7F, 0xF8, 0x87, 0x3F, 0x7F, 0xFC, 0x8F, 0x3F,
    0x3F, 0xFC, 0x0F, 0x3F, 0x0F, 0x3E, 0x1F, 0x3C, 0x0F, 0x1E, 0x1E, 0x3C, 0x0F, 0x1E, 0x1E, 0x3C,
    0x0F, 0x3E, 0x1F, 0x3C, 0x3F, 0xFC, 0x0F, 0x3F, 0x7F, 0xFC, 0x8F, 0x3F, 0x7F, 0xF8, 0x87, 0x3F,
    0x3F, 0xE0, 0x01, 0x3F, 0x3F, 0x00, 0x00, 0x3F, 0x7F, 0x00, 0x80, 0x3F, 0xFF, 0x0C, 0xCC, 0x3F,
    0xFF, 0x1F, 0xFE, 0x3F, 0xFF, 0x1F, 0xFE, 0x3F, 0xFF, 0xFF, 0xFF, 0x3F, 0xFF, 0xFF, 0xFF, 0x3F,
    0xFF, 0xFF, 0xFF, 0x3F, 0xFF, 0xFF, 0xFF, 0x3F
};

std::vector<uint8_t> Camera ={
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x07, 0xf8, 0xff, 0xff, 0x03, 0xf0, 0xff,
    0xff, 0x00, 0xc0, 0xff, 0x1f, 0x00, 0x00, 0xfc, 0x0f, 0x00, 0x00, 0xfc, 0x0f, 0xc0, 0x41, 0xfc,
    0x0f, 0x30, 0x02, 0xfc, 0x0f, 0x08, 0x04, 0xfc, 0x0f, 0x08, 0x08, 0xfc, 0x0f, 0xc8, 0x08, 0xfc,
    0x0f, 0xc8, 0x08, 0xfc, 0x0f, 0x08, 0x08, 0xfc, 0x0f, 0x08, 0x0c, 0xfc, 0x0f, 0x10, 0x06, 0xfc,
    0x0f, 0xe0, 0x01, 0xfc, 0x0f, 0x00, 0x00, 0xfc, 0x1f, 0x00, 0x00, 0xfc, 0x3f, 0x00, 0x00, 0xfe,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x3f

};

std::vector<uint8_t> Serial = {
    0xFF, 0xFF, 0xFF, 0x3F, 0xFF, 0xFF, 0xFF, 0x3F, 0xFF, 0xFF, 0xFF, 0x3F, 0xFF, 0xF9, 0xE7, 0x3F,
    0xFF, 0xF9, 0xE7, 0x3F, 0xFF, 0xF9, 0xE7, 0x3F, 0xFF, 0xF0, 0xE7, 0x3F, 0x7F, 0xE0, 0xE7, 0x3F,
    0x7F, 0xE0, 0xC3, 0x3F, 0x7F, 0xE0, 0xC3, 0x3F, 0x7F, 0xE0, 0xC3, 0x3F, 0x7F, 0xE0, 0xE7, 0x3F,
    0xFF, 0xF0, 0xE7, 0x3F, 0xFF, 0xF9, 0xE7, 0x3F, 0xFF, 0xF9, 0xE7, 0x3F, 0xFF, 0xF9, 0xE7, 0x3F,
    0xFF, 0xF9, 0xE7, 0x3F, 0xFF, 0xF9, 0xC3, 0x3F, 0xFF, 0xF9, 0x81, 0x3F, 0xFF, 0xF0, 0x81, 0x3F,
    0xFF, 0xF0, 0x81, 0x3F, 0xFF, 0xF0, 0x81, 0x3F, 0xFF, 0xF9, 0x81, 0x3F, 0xFF, 0xF9, 0xC3, 0x3F,
    0xFF, 0xF9, 0xE7, 0x3F, 0xFF, 0xF9, 0xE7, 0x3F, 0xFF, 0xF9, 0xE7, 0x3F, 0xFF, 0xFF, 0xFF, 0x3F,
    0xFF, 0xFF, 0xFF, 0x3F, 0xFF, 0xFF, 0xFF, 0x3F
};


std::vector<uint8_t> WIFI = {
    0xff, 0xff, 0xff, 0xff, 0xff, 0x07, 0xe0, 0xff, 0xff, 0x01, 0x80, 0xff, 0x7f, 0x00, 0x00, 0xfe,
    0x3f, 0x00, 0x00, 0xfc, 0x1f, 0xf0, 0x0f, 0xf8, 0x0f, 0xfc, 0x3f, 0xf0, 0x07, 0xff, 0xff, 0xe0,
    0xc3, 0x0f, 0xf0, 0xc3, 0xc1, 0x03, 0xc0, 0x83, 0xe1, 0x01, 0x80, 0x87, 0xf1, 0x80, 0x03, 0xcf,
    0x7f, 0xf0, 0x0f, 0xfe, 0x3f, 0xf8, 0x1f, 0xfc, 0x3f, 0xfc, 0x3f, 0xfc, 0x3f, 0x1e, 0x78, 0xfc,
    0xff, 0x0f, 0xf0, 0xff, 0xff, 0x07, 0xe0, 0xff, 0xff, 0x07, 0xe0, 0xff, 0xff, 0xc7, 0xe3, 0xff,
    0xff, 0xe7, 0xe7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x3f, 0xfc, 0xff, 0xff, 0x1f, 0xf8, 0xff,
    0xff, 0x1f, 0xf8, 0xff, 0xff, 0x1f, 0xf8, 0xff, 0xff, 0x1f, 0xf8, 0xff, 0xff, 0x1f, 0xf8, 0xff,
    0xff, 0x3f, 0xfc, 0xff, 0xff, 0xff, 0xff, 0xff
    };


void System_StartAnimation(void) {
    HAL::delay(1000);
    HAL::printInfo("System starting...");
    HAL::delay(500);
    HAL::printInfo("System finish Init... ");
    HAL::delay(500);
    HAL::printInfo("AstraUI is getting ready ");
    HAL::delay(500);
    HAL::printInfo("AstraUI Starting!!!");
    HAL::delay(1000);
    // 清除之前的信息显示
    HAL::canvasClear();
    HAL::canvasUpdate();
    // 获取屏幕配置
    const auto& screenConfig = HAL::getSystemConfig();
    const float radius = astra::getUIConfig().popRadius;  // 从配置获取圆角半径（如2px）
    // 加载条配置
    const int barWidth = static_cast<int>(screenConfig.screenWeight * 0.8f);  // 屏幕80%宽度
    const int barHeight = 10;                                                // 固定高度10px
    const int barX = (screenConfig.screenWeight - barWidth) / 2;             // 水平居中
    const int barY = screenConfig.screenHeight / 2;                          // 垂直居中
    // 加载文字配置
    std::string loadText = "loading...";
    uint8_t textWidth = HAL::getFontWidth(loadText);
    float textX = (screenConfig.screenWeight - textWidth) / 2.0f;
    float textY = barY - 12;  // 文字在加载条上方12px
    // 绘制静态元素（文字和边框只画一次）
    HAL::setDrawType(1);  // 实心模式绘制文字
    HAL::drawEnglish(textX, textY, loadText);
    HAL::setDrawType(1);  // 空心模式绘制边框
    HAL::drawRFrame(barX, barY, barWidth, barHeight, static_cast<uint8_t>(radius));  // 圆角边框用整数半径
    // 动态加载进度（每次刷新前清除上一次的填充）
    for (int i = 0; i <= 100; i += 5) {
        // 计算当前进度宽度（确保至少为0）
        int progressWidth = std::max(0, (barWidth - 2) * i / 100);
        // 清除上一次的填充区域（关键修复：避免填充叠加）
        HAL::setDrawType(0);  // 用背景色清除（假设实色为背景色）
        HAL::drawRBox(barX + 1, barY + 1, barWidth - 2, barHeight - 2, static_cast<uint8_t>(radius - 1));
        // 绘制新的进度填充（圆角半径比边框小1px，避免重叠）
        if (progressWidth > 0) {  // 进度为0时不绘制
            HAL::setDrawType(1);  // 用前景色填充（反色模式，与边框区分）
            HAL::drawRBox(barX + 1, barY + 1, progressWidth, barHeight - 2, static_cast<uint8_t>(radius - 1));
        }

        // 更新显示
        HAL::canvasUpdate();

        // 控制动画速度（总时长约1秒）
        HAL::delay(50);
    }
    HAL::canvasClear();
    HAL::setDrawType(1); // 确保设置为正常绘制模式
    HAL::canvasUpdate();
    astra::drawLogo(100);
}



auto *astraLauncher = new astra::Launcher();
auto *rootPage = new astra::Tile("root");
auto *Settings = new astra::List("Setting",Setting);
auto *MyCamera = new astra::List("Camera",Camera);
//auto* About = new astra::List("-About");      // About子菜单
astra::SerialMonitor* g_serialMonitor = new astra::SerialMonitor("SerialMonitor");
//astra::SerialMonitor* g_serialMonitor2 = new astra::SerialMonitor("SerialMonitor");
astra::Clock* MyClock = new astra::Clock("Timer");
astra::HardwareInfo* About = new astra::HardwareInfo("<About>"); // 列表中显示的项名

void MySerialMonitorUpdate() {
    //处理真实UART数据
    if (Uart1_flag == 1) { // 检测到UART1接收完成
        // 确保SerialMonitor活跃（isActive为true，避免未初始化时传数据）
        if (g_serialMonitor->isActive) {
            // 调用SerialMonitor的addData方法，传入接收数据和长度
            g_serialMonitor->addData(receiveData, receiveDatasize);
        }
        //重置状态：避免重复处理数据
        Uart1_flag = 0;                  // 重置接收标志
        receiveDatasize = 0;             // 重置接收长度
        memset(receiveData, 0, 50);      // 清空接收数组，准备下次接收
    }
}
//
bool checkBox_Value = false;
astra::CheckBox* checkBox = new astra::CheckBox(checkBox_Value);
unsigned char ScreenPopUp_Value = 0;
Widget_Selector widget_selector = Widget_Selector_NoSelect;
astra::PopUp*ScreenPopUp =  new astra::PopUp(1, "Screenmode", {"Light", "Dark"}, ScreenPopUp_Value);
unsigned char BrightnessSlider_Value = 200;
astra::Slider*slider = new astra::Slider("Brightness", 0, 200, 2, BrightnessSlider_Value);

void astraCoreInit(void) {

    HAL::inject(new Myhal);

    unsigned long bootStartTime = HAL::millis(); // 步骤1添加的起始时间

    System_StartAnimation();

    unsigned long bootTime = (HAL::millis() - bootStartTime)*0.001;
    std::string bootTimeStr = "Start-up time:" + std::to_string(bootTime) + "s";


    rootPage->addItem(Settings);
    rootPage->addItem(g_serialMonitor);
    rootPage->addItem(MyCamera);
    rootPage->addItem(MyClock);

    rootPage->addItem(new astra::Tile("Photo",Photo));
    rootPage->addItem(new astra::Tile("Weather",Weather));

    //rootPage->addItem(new astra::Tile("Timer",Timer));
    rootPage->addItem(new astra::Tile("Compass",Compass));
    rootPage->addItem(new astra::Tile("WIFI",WIFI));

    MyCamera->addItem(new astra::List("-test0"));

    Settings->addItem(About);

    Settings->addItem(new astra::List("-Brightness"),slider);
    Settings->addItem(new astra::List("-RGBLed"), checkBox);
    Settings->addItem(new astra::List("-ScreenMode"),ScreenPopUp);



    Settings->addItem(new astra::List("-test5"));
    Settings->addItem(new astra::List("-test5"));
    Settings->addItem(new astra::List("-test5"));
    Settings->addItem(new astra::List("-test5"));
    Settings->addItem(new astra::List("-test5"));



    astraLauncher->init(rootPage);
    astraLauncher->popInfo(bootTimeStr, 200);

}

//主程序入口
void CppMain(void) {
    static unsigned long lastDataTime = 0;
    static int dataCounter = 0;


    for(;;) {
        ws2812_Updata();





        //HAL_UART_Transmit_IT(&huart1, (uint8_t*)"hello", 5);

        MySerialMonitorUpdate();
        astraLauncher->update();
    }
}



